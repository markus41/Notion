%% Agent Streaming Response Pattern
%% Demonstrates real-time streaming of agent responses for improved user experience
%% Version: 1.0
%% Last Updated: 2025-10-15
%% Related Docs: /guides/developer/streaming-responses, /api/signalr-events

sequenceDiagram
    participant User as User Browser
    participant SignalR as SignalR Hub
    participant API as Orchestration API
    participant Agent as Agent Runtime
    participant LLM as Azure OpenAI
    participant Buffer as Response Buffer

    User->>SignalR: Connect WebSocket
    SignalR-->>User: Connection Established

    User->>API: Execute Agent Task
    API->>SignalR: Subscribe Client to Workflow

    API->>Agent: Execute with Streaming
    activate Agent

    Agent->>LLM: Stream Completion Request
    activate LLM
    Note over LLM: Stream: true<br/>Max tokens: 4096

    loop Streaming Chunks
        LLM-->>Agent: Response Chunk (SSE)
        Note over Agent,LLM: Chunk size: ~50-100 tokens

        Agent->>Buffer: Accumulate Chunk

        alt Buffer Threshold Reached (500 chars)
            Buffer-->>Agent: Buffered Content
            Agent->>SignalR: Broadcast Chunk
            SignalR-->>User: Real-time Update
            Note over User: Progressive UI Update

            Agent->>Buffer: Clear Buffer
        end
    end

    LLM-->>Agent: Stream Complete
    deactivate LLM

    Agent->>Buffer: Flush Remaining
    Buffer-->>Agent: Final Content
    Agent->>SignalR: Final Chunk + Complete Signal
    SignalR-->>User: Stream Complete

    Agent->>API: Task Complete
    deactivate Agent

    API->>SignalR: Workflow Status Update
    SignalR-->>User: Workflow Progress

    rect rgb(255, 245, 235)
        Note over User,Buffer: Streaming Benefits:<br/>- First byte in <100ms<br/>- Progressive rendering<br/>- Better perceived performance<br/>- Reduced memory usage
    end

    rect rgb(240, 255, 240)
        Note over Agent,Buffer: Buffer Strategy:<br/>- Size: 500 characters<br/>- Time: 200ms max wait<br/>- Prevents UI thrashing<br/>- Maintains readability
    end

    classDef realtime fill:#f59e0b,stroke:#d97706,color:#000
    classDef buffer fill:#8b5cf6,stroke:#7c3aed,color:#fff
    classDef streaming fill:#06b6d4,stroke:#0891b2,color:#fff
    classDef external fill:#0078d4,stroke:#005a9e,color:#fff

    class SignalR realtime
    class Buffer buffer
    class Agent,LLM streaming
    class API external