%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#0078d4', 'primaryTextColor':'#fff', 'primaryBorderColor':'#005a9e', 'lineColor':'#5c5c5c', 'secondaryColor':'#ff6600', 'tertiaryColor':'#10b981', 'quaternaryColor':'#ef4444', 'background':'#ffffff'}}}%%

graph TB
    subgraph "Global"
        dns["Azure DNS<br/>Global Traffic Manager<br/>---<br/>Geo-routing<br/>Health checks"]
        cdn["Azure CDN<br/>Edge Locations<br/>---<br/>Static assets<br/>API caching"]
    end

    subgraph "Primary Region: West US 2"
        subgraph "Edge Services"
            agw1["Application Gateway<br/>WAF v2<br/>---<br/>L7 load balancing<br/>SSL termination"]
            fw1["Azure Firewall<br/>Premium<br/>---<br/>Network security<br/>IDS/IPS"]
        end

        subgraph "Virtual Network (10.0.0.0/16)"
            subgraph "DMZ Subnet (10.0.1.0/24)"
                bastion1["Bastion Host<br/>---<br/>Secure RDP/SSH<br/>Jump server"]
            end

            subgraph "App Subnet (10.0.2.0/24)"
                subgraph "Container Apps Environment"
                    web1["Web App<br/>2-10 instances<br/>---<br/>React SPA<br/>nginx"]
                    api1["API Service<br/>3-20 instances<br/>---<br/>.NET 8<br/>Kestrel"]
                    agent1["Agent Service<br/>5-50 instances<br/>---<br/>Python 3.12<br/>FastAPI"]
                end
            end

            subgraph "Data Subnet (10.0.3.0/24)"
                cosmos1["Cosmos DB<br/>Multi-region write<br/>---<br/>99.999% SLA<br/>< 10ms latency"]
                redis1["Redis Enterprise<br/>3 nodes cluster<br/>---<br/>Active geo-replication<br/>120GB RAM"]
                storage1["Storage Account<br/>GRS redundancy<br/>---<br/>Hot/Cool/Archive tiers<br/>Lifecycle policies"]
            end

            subgraph "Integration Subnet (10.0.4.0/24)"
                sb1["Service Bus<br/>Premium<br/>---<br/>Message queuing<br/>Topics/Subscriptions"]
                evh1["Event Hub<br/>Standard<br/>---<br/>Event streaming<br/>1M events/sec"]
            end

            subgraph "Management Subnet (10.0.5.0/24)"
                kv1["Key Vault<br/>Premium HSM<br/>---<br/>Secrets management<br/>Certificate store"]
                acr1["Container Registry<br/>Premium<br/>---<br/>Geo-replication<br/>OCI artifacts"]
                insights1["App Insights<br/>---<br/>APM monitoring<br/>Log analytics"]
            end

            subgraph "Private Endpoints Subnet (10.0.6.0/24)"
                pe1["Private Endpoints<br/>---<br/>Cosmos DB<br/>Storage<br/>Key Vault<br/>ACR"]
            end
        end
    end

    subgraph "Secondary Region: East US"
        subgraph "Edge Services DR"
            agw2["Application Gateway<br/>WAF v2<br/>---<br/>Standby mode"]
            fw2["Azure Firewall<br/>Premium<br/>---<br/>Standby mode"]
        end

        subgraph "Virtual Network (10.1.0.0/16)"
            subgraph "App Subnet DR (10.1.2.0/24)"
                subgraph "Container Apps Environment DR"
                    web2["Web App<br/>0-5 instances<br/>---<br/>Scaled down"]
                    api2["API Service<br/>0-10 instances<br/>---<br/>Scaled down"]
                    agent2["Agent Service<br/>0-25 instances<br/>---<br/>Scaled down"]
                end
            end

            subgraph "Data Subnet DR (10.1.3.0/24)"
                cosmos2["Cosmos DB<br/>Read replica<br/>---<br/>Automatic failover<br/>RPO < 5 min"]
                redis2["Redis Enterprise<br/>Passive replica<br/>---<br/>Read-only mode"]
                storage2["Storage Account<br/>GRS secondary<br/>---<br/>Read-access enabled"]
            end
        end
    end

    subgraph "DevOps & CI/CD"
        gh["GitHub<br/>Source control<br/>---<br/>GitHub Actions<br/>PR workflows"]
        ado["Azure DevOps<br/>---<br/>Release pipelines<br/>Artifact management"]
        terraform["Terraform Cloud<br/>---<br/>IaC state<br/>Drift detection"]
    end

    subgraph "Monitoring & Security"
        sentinel["Azure Sentinel<br/>SIEM/SOAR<br/>---<br/>Threat detection<br/>Incident response"]
        defender["Defender for Cloud<br/>---<br/>Security posture<br/>Vulnerability scanning"]
        monitor["Azure Monitor<br/>---<br/>Metrics & alerts<br/>Dashboards"]
        backup["Azure Backup<br/>---<br/>Automated backups<br/>30-day retention"]
    end

    subgraph "External Services"
        openai["Azure OpenAI<br/>West US<br/>---<br/>GPT-4 Turbo<br/>100K TPM"]
        aad["Azure AD B2C<br/>---<br/>User authentication<br/>Social login"]
        sendgrid["SendGrid<br/>---<br/>Email delivery<br/>100K/month"]
    end

    dns -->|Route traffic| cdn
    cdn -->|Origin| agw1
    cdn -->|Failover| agw2

    agw1 --> fw1
    fw1 --> web1
    web1 --> api1
    api1 --> agent1

    api1 --> cosmos1
    api1 --> redis1
    api1 --> storage1
    api1 --> sb1
    agent1 --> evh1
    api1 --> kv1

    web1 -.->|Pull images| acr1
    api1 -.->|Pull images| acr1
    agent1 -.->|Pull images| acr1

    cosmos1 -.->|Replication| cosmos2
    redis1 -.->|Replication| redis2
    storage1 -.->|Replication| storage2

    agw2 --> fw2
    fw2 --> web2
    web2 --> api2
    api2 --> agent2

    api2 --> cosmos2
    api2 --> redis2
    api2 --> storage2

    agent1 -->|API calls| openai
    api1 -->|OAuth| aad
    api1 -->|SMTP| sendgrid

    gh -->|Deploy| ado
    ado -->|Release| web1
    ado -->|Release| api1
    ado -->|Release| agent1
    terraform -->|Provision| cosmos1
    terraform -->|Provision| redis1

    api1 -->|Logs| insights1
    insights1 -->|Feed| monitor
    monitor -->|Alert| sentinel
    fw1 -->|Logs| sentinel
    cosmos1 -->|Scan| defender
    storage1 -->|Backup| backup

    classDef edge fill:#fce4ec,stroke:#c2185b,color:#000
    classDef network fill:#e3f2fd,stroke:#1976d2,color:#000
    classDef compute fill:#fff3e0,stroke:#f57c00,color:#000
    classDef data fill:#e8f5e9,stroke:#388e3c,color:#000
    classDef integration fill:#f3e5f5,stroke:#7b1fa2,color:#fff
    classDef management fill:#e0f2f1,stroke:#00695c,color:#000
    classDef devops fill:#fafafa,stroke:#424242,color:#000
    classDef monitor fill:#efebe9,stroke:#5d4037,color:#000
    classDef external fill:#e1f5fe,stroke:#01579b,color:#000

    class dns,cdn,agw1,agw2,fw1,fw2 edge
    class bastion1 network
    class web1,web2,api1,api2,agent1,agent2 compute
    class cosmos1,cosmos2,redis1,redis2,storage1,storage2 data
    class sb1,evh1 integration
    class kv1,acr1,insights1,pe1 management
    class gh,ado,terraform devops
    class sentinel,defender,monitor,backup monitor
    class openai,aad,sendgrid external