%% High-Availability Azure Deployment Topology
%% Shows production-grade deployment with redundancy and failover
%% Establishes resilient infrastructure for mission-critical operations
%% Version: 1.0
%% Last Updated: 2025-10-14

graph TB
    subgraph "Azure Global Services"
        traffic_manager["Traffic Manager<br/>---<br/>Geographic routing<br/>Health monitoring"]
        front_door["Azure Front Door<br/>---<br/>Global CDN<br/>WAF protection"]
    end

    subgraph "Primary Region: East US"
        subgraph "Availability Zone 1"
            aks_node1["AKS Node Pool 1<br/>---<br/>3 x D4s_v5<br/>Auto-scaling 3-10"]
            webapp_pod1["Web App Pods<br/>---<br/>3 replicas<br/>Rolling updates"]
            api_pod1["API Pods<br/>---<br/>3 replicas<br/>Liveness probes"]
            agent_pod1["Agent Pods<br/>---<br/>5 replicas<br/>HPA enabled"]
        end

        subgraph "Availability Zone 2"
            aks_node2["AKS Node Pool 2<br/>---<br/>3 x D4s_v5<br/>Auto-scaling 3-10"]
            webapp_pod2["Web App Pods<br/>---<br/>3 replicas<br/>Anti-affinity rules"]
            api_pod2["API Pods<br/>---<br/>3 replicas<br/>Pod disruption budget"]
            agent_pod2["Agent Pods<br/>---<br/>5 replicas<br/>Resource limits"]
        end

        subgraph "Shared Services East"
            cosmos_east["Cosmos DB<br/>---<br/>Dedicated throughput<br/>Multi-master writes"]
            redis_east["Redis Enterprise<br/>---<br/>Cluster mode<br/>Geo-replication"]
            storage_east["Storage Account<br/>---<br/>ZRS replication<br/>Private endpoints"]
            openai_east["Azure OpenAI<br/>---<br/>GPT-4 (100 TPM)<br/>Reserved capacity"]
            keyvault_east["Key Vault<br/>---<br/>Premium HSM<br/>Geo-replicated"]
        end

        subgraph "Monitoring East"
            insights_east["Application Insights<br/>---<br/>30-day retention<br/>Continuous export"]
            log_analytics_east["Log Analytics<br/>---<br/>90-day retention<br/>Alert rules"]
        end
    end

    subgraph "Secondary Region: West US"
        subgraph "Availability Zone 1 West"
            aks_node3["AKS Node Pool 3<br/>---<br/>2 x D4s_v5<br/>Standby mode"]
            webapp_pod3["Web App Pods<br/>---<br/>2 replicas<br/>Ready for scale"]
            api_pod3["API Pods<br/>---<br/>2 replicas<br/>Warm standby"]
            agent_pod3["Agent Pods<br/>---<br/>3 replicas<br/>Reduced capacity"]
        end

        subgraph "Shared Services West"
            cosmos_west["Cosmos DB<br/>---<br/>Read replica<br/>Automatic failover"]
            redis_west["Redis Enterprise<br/>---<br/>Passive replica<br/>RTO < 1 min"]
            storage_west["Storage Account<br/>---<br/>GRS replica<br/>Read-access enabled"]
            openai_west["Azure OpenAI<br/>---<br/>GPT-4 (50 TPM)<br/>Backup capacity"]
            keyvault_west["Key Vault<br/>---<br/>Replicated secrets<br/>DR ready"]
        end

        subgraph "Monitoring West"
            insights_west["Application Insights<br/>---<br/>Failover instance<br/>Independent collection"]
        end
    end

    subgraph "Shared Infrastructure"
        acr_geo["Container Registry<br/>---<br/>Premium tier<br/>Geo-replication"]
        signalr_premium["SignalR Service<br/>---<br/>Standard S1<br/>100K connections"]
        backup_vault["Backup Vault<br/>---<br/>GRS backup<br/>30-day retention"]
    end

    %% Traffic flow
    traffic_manager -->|Primary| front_door
    front_door -->|Route| aks_node1
    front_door -->|Route| aks_node2
    front_door -->|Failover| aks_node3

    %% Pod distribution
    aks_node1 --> webapp_pod1
    aks_node1 --> api_pod1
    aks_node1 --> agent_pod1
    aks_node2 --> webapp_pod2
    aks_node2 --> api_pod2
    aks_node2 --> agent_pod2
    aks_node3 --> webapp_pod3
    aks_node3 --> api_pod3
    aks_node3 --> agent_pod3

    %% Service connections East
    api_pod1 --> cosmos_east
    api_pod2 --> cosmos_east
    agent_pod1 --> redis_east
    agent_pod2 --> redis_east
    agent_pod1 --> storage_east
    agent_pod2 --> openai_east

    %% Service connections West
    api_pod3 --> cosmos_west
    agent_pod3 --> redis_west
    agent_pod3 --> storage_west
    agent_pod3 --> openai_west

    %% Replication
    cosmos_east <-->|Sync| cosmos_west
    redis_east -->|Replicate| redis_west
    storage_east -->|GRS| storage_west
    keyvault_east <-->|Sync| keyvault_west

    %% Shared services
    aks_node1 -->|Pull| acr_geo
    aks_node2 -->|Pull| acr_geo
    aks_node3 -->|Pull| acr_geo
    api_pod1 -->|WebSocket| signalr_premium
    cosmos_east -->|Backup| backup_vault

    %% Monitoring
    aks_node1 -->|Metrics| insights_east
    aks_node2 -->|Logs| log_analytics_east
    aks_node3 -->|Metrics| insights_west

    %% Apply semantic color coding
    classDef global fill:#f59e0b,stroke:#d97706,color:#000,stroke-width:3px
    classDef compute fill:#0078d4,stroke:#005a9e,color:#fff,stroke-width:2px
    classDef data fill:#336791,stroke:#254a6b,color:#fff,stroke-width:2px
    classDef ai fill:#ec4899,stroke:#db2777,color:#fff,stroke-width:2px
    classDef monitor fill:#10b981,stroke:#059669,color:#fff,stroke-width:2px
    classDef shared fill:#8b5cf6,stroke:#7c3aed,color:#fff,stroke-width:2px

    class traffic_manager,front_door global
    class aks_node1,aks_node2,aks_node3,webapp_pod1,webapp_pod2,webapp_pod3,api_pod1,api_pod2,api_pod3,agent_pod1,agent_pod2,agent_pod3 compute
    class cosmos_east,cosmos_west,redis_east,redis_west,storage_east,storage_west data
    class openai_east,openai_west,keyvault_east,keyvault_west ai
    class insights_east,insights_west,log_analytics_east monitor
    class acr_geo,signalr_premium,backup_vault shared