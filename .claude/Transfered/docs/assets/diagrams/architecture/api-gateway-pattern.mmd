%% API Gateway Pattern Architecture
%% Shows API gateway as single entry point for microservices
%% Streamlines API management and security across distributed services
%% Version: 1.0
%% Last Updated: 2025-10-14

graph TB
    subgraph "External Clients"
        web_client["Web Application<br/>---<br/>React SPA<br/>Bearer tokens"]
        mobile_client["Mobile Apps<br/>---<br/>iOS/Android<br/>OAuth 2.0"]
        partner_api["Partner Systems<br/>---<br/>B2B integration<br/>API keys"]
        iot_devices["IoT Devices<br/>---<br/>Telemetry data<br/>Device tokens"]
    end

    subgraph "API Gateway Layer"
        subgraph "Azure API Management"
            apim["API Management<br/>---<br/>Premium tier<br/>Multi-region"]

            subgraph "Gateway Components"
                rate_limiter["Rate Limiting<br/>---<br/>Token bucket<br/>Per-client quotas"]
                auth_validator["Auth Validation<br/>---<br/>JWT verification<br/>OAuth flows"]
                request_transform["Request Transform<br/>---<br/>Header enrichment<br/>Protocol translation"]
                response_cache["Response Cache<br/>---<br/>Redis backend<br/>TTL management"]
                api_versioning["API Versioning<br/>---<br/>v1, v2, v3<br/>Deprecation handling"]
            end

            subgraph "Policies"
                inbound_policy["Inbound Policies<br/>---<br/>Validation<br/>Transformation"]
                backend_policy["Backend Policies<br/>---<br/>Retry logic<br/>Circuit breaker"]
                outbound_policy["Outbound Policies<br/>---<br/>Response shaping<br/>CORS headers"]
                error_policy["Error Policies<br/>---<br/>Error mapping<br/>Fallback responses"]
            end
        end

        subgraph "Developer Portal"
            dev_portal["Developer Portal<br/>---<br/>API documentation<br/>Interactive testing"]
            api_catalog["API Catalog<br/>---<br/>OpenAPI specs<br/>SDK generation"]
            subscription_mgmt["Subscription Mgmt<br/>---<br/>API keys<br/>Usage analytics"]
        end
    end

    subgraph "Backend Services"
        subgraph "Core Services"
            workflow_api["Workflow API<br/>---<br/>.NET Core<br/>Port 5001"]
            agent_api["Agent API<br/>---<br/>Python FastAPI<br/>Port 8000"]
            analytics_api["Analytics API<br/>---<br/>Node.js<br/>Port 3000"]
        end

        subgraph "Domain Services"
            user_service["User Service<br/>---<br/>Authentication<br/>Profile management"]
            notification_service["Notification Service<br/>---<br/>Email/SMS<br/>Push notifications"]
            reporting_service["Reporting Service<br/>---<br/>Report generation<br/>Export APIs"]
        end

        subgraph "Integration Services"
            external_adapter["External Adapter<br/>---<br/>3rd party APIs<br/>Data mapping"]
            event_publisher["Event Publisher<br/>---<br/>Event Grid<br/>Webhooks"]
            file_service["File Service<br/>---<br/>Upload/download<br/>Virus scanning"]
        end
    end

    subgraph "Supporting Infrastructure"
        service_discovery["Service Discovery<br/>---<br/>Consul/K8s DNS<br/>Dynamic routing"]
        config_service["Config Service<br/>---<br/>App Configuration<br/>Feature flags"]
        secret_vault["Key Vault<br/>---<br/>API keys<br/>Certificates"]
    end

    subgraph "Observability"
        api_analytics["API Analytics<br/>---<br/>Usage patterns<br/>Performance metrics"]
        log_aggregation["Log Aggregation<br/>---<br/>Centralized logging<br/>Request tracing"]
        health_monitor["Health Monitor<br/>---<br/>Endpoint health<br/>SLA tracking"]
    end

    %% Client connections
    web_client -->|HTTPS| apim
    mobile_client -->|HTTPS| apim
    partner_api -->|HTTPS| apim
    iot_devices -->|MQTT/HTTPS| apim

    %% Gateway processing
    apim --> rate_limiter
    rate_limiter --> auth_validator
    auth_validator --> request_transform
    request_transform --> api_versioning

    api_versioning --> inbound_policy
    inbound_policy --> backend_policy
    backend_policy -->|Route| workflow_api
    backend_policy -->|Route| agent_api
    backend_policy -->|Route| analytics_api

    workflow_api --> outbound_policy
    agent_api --> outbound_policy
    analytics_api --> outbound_policy
    outbound_policy --> response_cache
    response_cache --> apim

    %% Service routing
    apim -->|/api/v1/users| user_service
    apim -->|/api/v1/notifications| notification_service
    apim -->|/api/v1/reports| reporting_service
    apim -->|/api/v1/external| external_adapter
    apim -->|/api/v1/events| event_publisher
    apim -->|/api/v1/files| file_service

    %% Supporting services
    apim --> service_discovery
    apim --> config_service
    auth_validator --> secret_vault

    %% Developer portal
    dev_portal --> api_catalog
    api_catalog --> subscription_mgmt
    subscription_mgmt --> apim

    %% Observability
    apim --> api_analytics
    apim --> log_aggregation
    backend_policy --> health_monitor

    %% Error handling
    backend_policy -->|Failure| error_policy
    error_policy -->|Fallback| response_cache

    %% Apply semantic color coding
    classDef client fill:#94a3b8,stroke:#64748b,color:#fff,stroke-width:2px
    classDef gateway fill:#f59e0b,stroke:#d97706,color:#000,stroke-width:3px
    classDef component fill:#3eaf7c,stroke:#2d8659,color:#fff,stroke-width:2px
    classDef policy fill:#ec4899,stroke:#db2777,color:#fff,stroke-width:2px
    classDef service fill:#0078d4,stroke:#005a9e,color:#fff,stroke-width:2px
    classDef support fill:#8b5cf6,stroke:#7c3aed,color:#fff,stroke-width:2px
    classDef observability fill:#10b981,stroke:#059669,color:#fff,stroke-width:2px

    class web_client,mobile_client,partner_api,iot_devices client
    class apim gateway
    class rate_limiter,auth_validator,request_transform,response_cache,api_versioning component
    class inbound_policy,backend_policy,outbound_policy,error_policy policy
    class workflow_api,agent_api,analytics_api,user_service,notification_service,reporting_service,external_adapter,event_publisher,file_service service
    class service_discovery,config_service,secret_vault,dev_portal,api_catalog,subscription_mgmt support
    class api_analytics,log_aggregation,health_monitor observability