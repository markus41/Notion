%% C4 Component Diagram - Python Agent Service Components
%% Shows the internal architecture of the Python meta-agents service
%% Designed to support scalable agent operations across teams
%% Version: 1.0
%% Last Updated: 2025-10-14

graph TB
    subgraph "Python Agent Service (FastAPI)"
        subgraph "API Layer"
            fast_api["FastAPI Application<br/>---<br/>REST endpoints<br/>and OpenAPI docs"]
            task_router["TaskRouter<br/>---<br/>Task routing<br/>to agents"]
            stream_handler["StreamHandler<br/>---<br/>SSE streaming<br/>responses"]
        end

        subgraph "Agent Types"
            architect_agent["ArchitectAgent<br/>---<br/>System design and<br/>architecture decisions"]
            builder_agent["BuilderAgent<br/>---<br/>Code generation and<br/>implementation"]
            validator_agent["ValidatorAgent<br/>---<br/>Quality assurance<br/>and testing"]
            scribe_agent["ScribeAgent<br/>---<br/>Documentation and<br/>specification writing"]
            custom_agents["CustomAgents<br/>---<br/>Domain-specific<br/>agent extensions"]
        end

        subgraph "Core Framework"
            base_agent["BaseAgent<br/>---<br/>Abstract agent<br/>interface"]
            agent_factory["AgentFactory<br/>---<br/>Agent instantiation<br/>and lifecycle"]
            context_manager["ContextManager<br/>---<br/>Thread-safe context<br/>propagation"]
            memory_manager["MemoryManager<br/>---<br/>Agent memory and<br/>conversation history"]
        end

        subgraph "LLM Integration"
            openai_client["OpenAIClient<br/>---<br/>Azure OpenAI<br/>integration"]
            prompt_manager["PromptManager<br/>---<br/>Template management<br/>and optimization"]
            token_counter["TokenCounter<br/>---<br/>Token usage<br/>tracking"]
            response_parser["ResponseParser<br/>---<br/>Structured output<br/>parsing"]
        end

        subgraph "Persistence Layer"
            cosmos_adapter["CosmosAdapter<br/>---<br/>Cosmos DB<br/>operations"]
            cache_manager["CacheManager<br/>---<br/>Redis caching<br/>strategy"]
            blob_storage["BlobStorage<br/>---<br/>Artifact storage<br/>in Azure Blob"]
        end

        subgraph "Observability"
            tracer["OpenTelemetryTracer<br/>---<br/>Distributed tracing<br/>instrumentation"]
            metrics_collector["MetricsCollector<br/>---<br/>Performance metrics<br/>collection"]
            logger["StructuredLogger<br/>---<br/>Contextual logging<br/>with correlation"]
        end

        subgraph "Utilities"
            retry_handler["RetryHandler<br/>---<br/>Retry logic with<br/>exponential backoff"]
            rate_limiter["RateLimiter<br/>---<br/>Token bucket<br/>rate limiting"]
            health_check["HealthCheck<br/>---<br/>Dependency health<br/>monitoring"]
        end
    end

    %% Internal connections
    fast_api --> task_router
    fast_api --> stream_handler
    task_router --> agent_factory

    agent_factory --> architect_agent
    agent_factory --> builder_agent
    agent_factory --> validator_agent
    agent_factory --> scribe_agent
    agent_factory --> custom_agents

    architect_agent --> base_agent
    builder_agent --> base_agent
    validator_agent --> base_agent
    scribe_agent --> base_agent
    custom_agents --> base_agent

    base_agent --> context_manager
    base_agent --> memory_manager
    base_agent --> openai_client

    openai_client --> prompt_manager
    openai_client --> token_counter
    openai_client --> response_parser

    memory_manager --> cosmos_adapter
    memory_manager --> cache_manager
    base_agent --> blob_storage

    fast_api --> tracer
    base_agent --> metrics_collector
    base_agent --> logger

    openai_client --> retry_handler
    fast_api --> rate_limiter
    fast_api --> health_check

    %% Apply semantic color coding
    classDef api fill:#61dafb,stroke:#4fa8c5,color:#000,stroke-width:2px
    classDef agent fill:#8b5cf6,stroke:#7c3aed,color:#fff,stroke-width:3px
    classDef core fill:#3eaf7c,stroke:#2d8659,color:#fff,stroke-width:2px
    classDef llm fill:#f59e0b,stroke:#d97706,color:#000,stroke-width:2px
    classDef persistence fill:#336791,stroke:#254a6b,color:#fff,stroke-width:2px
    classDef observability fill:#ef4444,stroke:#dc2626,color:#fff,stroke-width:2px
    classDef utility fill:#94a3b8,stroke:#64748b,color:#fff,stroke-width:2px

    class fast_api,task_router,stream_handler api
    class architect_agent,builder_agent,validator_agent,scribe_agent,custom_agents agent
    class base_agent,agent_factory,context_manager,memory_manager core
    class openai_client,prompt_manager,token_counter,response_parser llm
    class cosmos_adapter,cache_manager,blob_storage persistence
    class tracer,metrics_collector,logger observability
    class retry_handler,rate_limiter,health_check utility